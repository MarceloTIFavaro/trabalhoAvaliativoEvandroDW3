{% extends "templates/base.html" %}

{% block content %}

<h1 class="mt-4">Gerenciar Contas Gerais</h1>
<ol class="breadcrumb mb-4">
  <li class="breadcrumb-item active">Visão Geral</li>
</ol>

<!-- Cards de Resumo -->
<div class="row">
  <div class="col-xl-3 col-md-6">
    <div class="card bg-primary text-white mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-white-75 small">Total de Contas</div>
            <div class="fs-2 fw-bold" id="totalContas">0</div>
          </div>
          <i class="fas fa-list fa-3x opacity-50"></i>
        </div>
      </div>
      <div class="card-footer d-flex align-items-center justify-content-between">
        <a class="small text-white stretched-link" href="/contaspagar/gerenciar">Ver Detalhes</a>
        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card bg-warning text-white mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-white-75 small">Pendentes</div>
            <div class="fs-2 fw-bold" id="totalPendentes">0</div>
          </div>
          <i class="fas fa-clock fa-3x opacity-50"></i>
        </div>
      </div>
      <div class="card-footer d-flex align-items-center justify-content-between">
        <a class="small text-white stretched-link" href="/contaspagar/gerenciar">Ver Detalhes</a>
        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card bg-danger text-white mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-white-75 small">Atrasadas</div>
            <div class="fs-2 fw-bold" id="totalAtrasadas">0</div>
          </div>
          <i class="fas fa-exclamation-triangle fa-3x opacity-50 blink-animation"></i>
        </div>
      </div>
      <div class="card-footer d-flex align-items-center justify-content-between">
        <a class="small text-white stretched-link" href="/contaspagar/gerenciar">Ver Detalhes</a>
        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card bg-success text-white mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-white-75 small">Pagas</div>
            <div class="fs-2 fw-bold" id="totalPagas">0</div>
          </div>
          <i class="fas fa-check-circle fa-3x opacity-50"></i>
        </div>
      </div>
      <div class="card-footer d-flex align-items-center justify-content-between">
        <a class="small text-white stretched-link" href="/contaspagar/gerenciar">Ver Detalhes</a>
        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
      </div>
    </div>
  </div>
</div>

<!-- Notificações de Contas Atrasadas -->
<div id="notificacoesAtrasadas"></div>

<!-- Tabela de Contas Recentes -->
<div class="card mb-4">
  <div class="card-header">
    <i class="fas fa-table me-1"></i>
    Contas Recentes
  </div>
  <div class="card-body">
    <table class="table table-striped" id="tabelaContasRecentes">
      <thead>
        <tr>
          <th>Descrição</th>
          <th>Valor</th>
          <th>Vencimento</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tbodyContasRecentes">
        <tr>
          <td colspan="4" class="text-center">
            <i class="fas fa-spinner fa-spin"></i> Carregando...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const userId = {{ parametros.IdUsuario }};
  
  // Função para exibir toast
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    const bgColor = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const toastHTML = `
      <div id="${toastId}" class="toast align-items-center text-white ${bgColor} border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas ${icon} me-2"></i>${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
      toastElement.remove();
    });
  }
  
  // Função auxiliar para calcular o status efetivo da conta baseado nas parcelas
  function calcularStatusEfetivo(conta) {
    // Se a conta já está paga, mantém como pago
    if (conta.status === 'Pago') {
      return 'Pago';
    }
    
    // Se a conta tem parcelas, calcular baseado nas parcelas
    if (conta.parcelas && conta.parcelas.length > 0) {
      // Filtrar parcelas não pagas
      const parcelasNaoPagas = conta.parcelas.filter(p => 
        p.status !== 'Pago' && p.status !== 'PAGO' && p.status !== 'pago'
      );
      
      // Se todas as parcelas foram pagas, a conta deve estar paga
      if (parcelasNaoPagas.length === 0) {
        return 'Pago';
      }
      
      // Verificar se há parcelas atrasadas pendentes (não pagas)
      const temParcelasAtrasadas = parcelasNaoPagas.some(p => {
        // Verificar se a parcela está atrasada pela data
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const vencimento = new Date(p.data_vencimento);
        vencimento.setHours(0, 0, 0, 0);
        return (p.status === 'Atrasado' || p.status === 'ATRASADO' || p.status === 'atrasado') || vencimento < hoje;
      });
      
      // Se tem parcelas atrasadas pendentes, status é Atrasado
      if (temParcelasAtrasadas) {
        return 'Atrasado';
      }
      
      // Se há parcelas pendentes mas nenhuma atrasada, status é Pendente
      return 'Pendente';
    }
    
    // Para contas sem parcelas, verificar se está atrasada pela data
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const vencimento = new Date(conta.data_vencimento);
    vencimento.setHours(0, 0, 0, 0);
    
    if (conta.status === 'Pago') {
      return 'Pago';
    } else if (conta.status === 'Atrasado' || (conta.status !== 'Pago' && vencimento < hoje)) {
      return 'Atrasado';
    }
    
    return conta.status || 'Pendente';
  }
  
  // Função auxiliar para obter o vencimento efetivo da conta (próxima parcela pendente se tiver parcelas)
  function obterVencimentoEfetivo(conta) {
    // Se a conta tem parcelas, buscar a próxima parcela pendente
    if (conta.parcelas && conta.parcelas.length > 0) {
      // Filtrar parcelas não pagas
      const parcelasPendentes = conta.parcelas.filter(p => 
        p.status !== 'Pago' && p.status !== 'PAGO' && p.status !== 'pago'
      );
      
      if (parcelasPendentes.length > 0) {
        // Ordenar por data de vencimento e pegar a primeira (mais próxima)
        parcelasPendentes.sort((a, b) => {
          const dataA = new Date(a.data_vencimento);
          const dataB = new Date(b.data_vencimento);
          return dataA - dataB;
        });
        
        // Retornar o vencimento da próxima parcela pendente
        return parcelasPendentes[0].data_vencimento;
      } else {
        // Se todas as parcelas estão pagas, retornar o vencimento da última parcela
        const parcelasOrdenadas = [...conta.parcelas].sort((a, b) => {
          const dataA = new Date(a.data_vencimento);
          const dataB = new Date(b.data_vencimento);
          return dataB - dataA; // Ordenar do mais recente para o mais antigo
        });
        return parcelasOrdenadas[0]?.data_vencimento || conta.data_vencimento;
      }
    }
    
    // Se não tem parcelas, retornar o vencimento normal da conta
    return conta.data_vencimento;
  }
  
  // Função para formatar data
  function formatarData(dataStr) {
    const data = new Date(dataStr);
    return data.toLocaleDateString('pt-BR');
  }
  
  // Função para formatar valor
  function formatarValor(valor) {
    return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }
  
  // Carregar dados do dashboard
  async function carregarDashboard() {
    try {
      const response = await axios.get('/contaspagar/listar');
      
      if (response.data.status === 'ok') {
        const contas = response.data.contas;
        
        // Carregar parcelas para cada conta
        for (let i = 0; i < contas.length; i++) {
          try {
            const parcelasResponse = await axios.post('/parcelas/listar', { id_conta: contas[i].id_contas });
            if (parcelasResponse.data.status === 'ok') {
              contas[i].parcelas = parcelasResponse.data.parcelas || [];
            }
          } catch (error) {
            console.error(`Erro ao carregar parcelas da conta ${contas[i].id_contas}:`, error);
            contas[i].parcelas = [];
          }
        }
        
        // Calcular totais usando status efetivo
        let totalPendentes = 0;
        let totalAtrasadas = 0;
        let totalPagas = 0;
        const contasAtrasadas = [];
        
        contas.forEach(conta => {
          const statusEfetivo = calcularStatusEfetivo(conta);
          
          if (statusEfetivo === 'Pago') {
            totalPagas++;
          } else if (statusEfetivo === 'Atrasado') {
            totalAtrasadas++;
            contasAtrasadas.push(conta);
          } else if (statusEfetivo === 'Pendente') {
            totalPendentes++;
          }
        });
        
        // Atualizar cards
        document.getElementById('totalContas').textContent = contas.length;
        document.getElementById('totalPendentes').textContent = totalPendentes;
        document.getElementById('totalAtrasadas').textContent = totalAtrasadas;
        document.getElementById('totalPagas').textContent = totalPagas;
        
        // Exibir notificações de contas atrasadas
        if (contasAtrasadas.length > 0) {
          const notificacoesDiv = document.getElementById('notificacoesAtrasadas');
          notificacoesDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <h5 class="alert-heading">
                <i class="fas fa-exclamation-triangle blink-animation"></i> 
                Atenção! Você tem ${contasAtrasadas.length} conta(s) atrasada(s)
              </h5>
              <hr>
              <ul class="mb-0">
                ${contasAtrasadas.map(c => {
                  const vencimentoEfetivo = obterVencimentoEfetivo(c);
                  return `<li><strong>${c.descricao}</strong> - Vencimento: ${formatarData(vencimentoEfetivo)} - ${formatarValor(c.valor)}</li>`;
                }).join('')}
              </ul>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
        } else {
          // Limpar notificações se não há contas atrasadas
          const notificacoesDiv = document.getElementById('notificacoesAtrasadas');
          notificacoesDiv.innerHTML = '';
        }
        
        // Preencher tabela de contas recentes usando status e vencimento efetivo
        const tbody = document.getElementById('tbodyContasRecentes');
        if (contas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhuma conta cadastrada</td></tr>';
        } else {
          const contasRecentes = contas.slice(0, 5);
          tbody.innerHTML = contasRecentes.map(conta => {
            const statusEfetivo = calcularStatusEfetivo(conta);
            const vencimentoEfetivo = obterVencimentoEfetivo(conta);
            const statusClass = statusEfetivo === 'Pago' ? 'success' : (statusEfetivo === 'Atrasado' ? 'danger' : 'warning');
            const rowClass = statusEfetivo === 'Atrasado' ? 'table-danger' : '';
            
            return `
              <tr class="${rowClass}">
                <td>${conta.descricao}</td>
                <td>${formatarValor(conta.valor)}</td>
                <td>${formatarData(vencimentoEfetivo)}</td>
                <td>
                  <span class="badge bg-${statusClass}">
                    ${statusEfetivo}
                    ${statusEfetivo === 'Atrasado' ? '<i class="fas fa-exclamation-triangle ms-1"></i>' : ''}
                  </span>
                </td>
              </tr>
            `;
          }).join('');
        }
      }
    } catch (error) {
      console.error('Erro ao carregar dashboard:', error);
      showToast('Erro ao carregar dados do dashboard', 'error');
    }
  }
  
  // Carregar ao iniciar a página
  window.onload = function() {
    carregarDashboard();
  };
</script>

{% endblock %}

