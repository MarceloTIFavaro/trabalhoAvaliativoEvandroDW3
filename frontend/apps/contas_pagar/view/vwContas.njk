{% extends "templates/base.html" %}

{% block content %}

<h1 class="mt-4">Gerenciar Contas a Pagar</h1>
<ol class="breadcrumb mb-4">
  <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
  <li class="breadcrumb-item active">Contas a Pagar</li>
</ol>

<!-- Notificações de Contas Atrasadas -->
<div id="notificacoesAtrasadas"></div>

<!-- Ações -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="fas fa-table me-1"></i> Minhas Contas</span>
    <div>
      <select id="filtroStatus" class="form-select form-select-sm d-inline-block w-auto me-2">
        <option value="">Todos os Status</option>
        <option value="Pendente">Pendente</option>
        <option value="Atrasado">Atrasado</option>
        <option value="Pago">Pago</option>
      </select>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalConta" onclick="abrirModalNovaConta()">
        <i class="fas fa-plus"></i> Nova Conta
      </button>
    </div>
  </div>
  <div class="card-body">
    <table class="table table-striped table-hover" id="tabelaContas">
      <thead>
        <tr>
          <th>Descrição</th>
          <th>Valor</th>
          <th>Vencimento</th>
          <th>Status</th>
          <th>Parcelas</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyContas">
        <tr>
          <td colspan="6" class="text-center">
            <i class="fas fa-spinner fa-spin"></i> Carregando contas...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Nova/Editar Conta -->
<div class="modal fade" id="modalConta" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitulo">Nova Conta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="formConta">
        <div class="modal-body">
          <input type="hidden" id="contaId">
          
          <div class="mb-3">
            <label for="contaDescricao" class="form-label">
              <i class="fas fa-file-alt"></i> Descrição *
            </label>
            <input type="text" class="form-control" id="contaDescricao" required placeholder="Ex: Conta de energia">
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="contaValor" class="form-label">
                <i class="fas fa-dollar-sign"></i> Valor (R$) *
              </label>
              <input type="number" class="form-control" id="contaValor" step="0.01" min="0" required placeholder="0.00" oninput="calcularParcelas()">
            </div>
            <div class="col-md-6 mb-3" id="containerVencimento">
              <label for="contaVencimento" class="form-label">
                <i class="fas fa-calendar"></i> Vencimento *
              </label>
              <input type="date" class="form-control" id="contaVencimento" required>
            </div>
          </div>

          <!-- Opção de Parcelamento -->
          <div class="mb-3">
            <label for="parcelarConta" class="form-label">
              <i class="fas fa-calendar-check"></i> Parcelar esta conta
            </label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="parcelarConta" onchange="toggleParcelas()">
              <label class="form-check-label" for="parcelarConta">
                Criar parcelas para esta conta
              </label>
            </div>
          </div>

          <!-- Campos de Parcelamento (ocultos por padrão) -->
          <div id="camposParcelas" style="display: none;">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="numeroParcelas" class="form-label">
                  <i class="fas fa-list-ol"></i> Número de Parcelas (máx. 12)
                </label>
                <input type="number" class="form-control" id="numeroParcelas" min="1" max="12" placeholder="Ex: 3" required oninput="calcularParcelas()">
              </div>
              <div class="col-md-4 mb-3">
                <label for="dataPrimeiraParcela" class="form-label">
                  <i class="fas fa-calendar-alt"></i> Data da 1ª Parcela *
                </label>
                <input type="date" class="form-control" id="dataPrimeiraParcela" required onchange="calcularParcelas()">
              </div>
              <div class="col-md-4 mb-3">
                <label for="intervaloDias" class="form-label">
                  <i class="fas fa-calendar-day"></i> Intervalo entre parcelas (dias) *
                </label>
                <input type="number" class="form-control" id="intervaloDias" min="1" value="30" required placeholder="Ex: 30" oninput="calcularParcelas()">
              </div>
            </div>
            
            <!-- Preview das Parcelas -->
            <div id="previewParcelas" style="display: none;" class="alert alert-info mt-3">
              <h6 class="alert-heading"><i class="fas fa-eye"></i> Preview das Parcelas</h6>
              <hr>
              <div id="parcelasPreviewContent" class="small"></div>
            </div>
          </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="btnSalvar">
            <i class="fas fa-save"></i> Salvar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
  const userId = {{ parametros.IdUsuario }};
  let contasGlobal = [];
  
  // Função para exibir toast
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    const bgColor = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const toastHTML = `
      <div id="${toastId}" class="toast align-items-center text-white ${bgColor} border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas ${icon} me-2"></i>${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
      toastElement.remove();
    });
  }
  
  // Impedir valores negativos no campo de valor
  document.addEventListener('input', function(e) {
    if (e.target && e.target.id === 'contaValor') {
      const num = parseFloat(e.target.value);
      if (!isNaN(num) && num < 0) {
        e.target.value = 0;
      }
    }
  });
  
  // Função para formatar data
  function formatarData(dataStr) {
    const data = new Date(dataStr);
    return data.toLocaleDateString('pt-BR');
  }
  
  // Função para formatar data para input
  function formatarDataInput(dataStr) {
    const data = new Date(dataStr);
    return data.toISOString().split('T')[0];
  }
  
  // Função para formatar valor
  function formatarValor(valor) {
    return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }
  
  // Carregar contas
  async function carregarContas() {
    try {
      const response = await axios.get('/contaspagar/listar');
      
      if (response.data.status === 'ok') {
        contasGlobal = response.data.contas;
        
        // Carregar parcelas para cada conta
        for (let i = 0; i < contasGlobal.length; i++) {
          try {
            const parcelasResponse = await axios.post('/parcelas/listar', { id_conta: contasGlobal[i].id_contas });
            if (parcelasResponse.data.status === 'ok') {
              contasGlobal[i].parcelas = parcelasResponse.data.parcelas || [];
            }
          } catch (error) {
            console.error(`Erro ao carregar parcelas da conta ${contasGlobal[i].id_contas}:`, error);
            contasGlobal[i].parcelas = [];
          }
        }
        
        renderizarContas(contasGlobal);
        
        // Verificar contas atrasadas (o status já vem calculado do backend)
        const contasAtrasadas = contasGlobal.filter(c => c.status === 'Atrasado');
        
        if (contasAtrasadas.length > 0) {
          const notificacoesDiv = document.getElementById('notificacoesAtrasadas');
          notificacoesDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <h5 class="alert-heading">
                <i class="fas fa-exclamation-triangle"></i> 
                Atenção! Você tem ${contasAtrasadas.length} conta(s) atrasada(s)
              </h5>
              <hr>
              <ul class="mb-0">
                ${contasAtrasadas.map(c => `<li><strong>${c.descricao}</strong> - Vencimento: ${formatarData(c.data_vencimento)} - ${formatarValor(c.valor)}</li>`).join('')}
              </ul>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('Erro ao carregar contas:', error);
      showToast('Erro ao carregar contas', 'error');
    }
  }
  
  // Renderizar contas na tabela
  function renderizarContas(contas) {
    const tbody = document.getElementById('tbodyContas');
    
    if (contas.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhuma conta cadastrada</td></tr>';
      return;
    }
    
    
    tbody.innerHTML = contas.map(conta => {
      const statusClass = conta.status === 'Pago' ? 'success' : (conta.status === 'Atrasado' ? 'danger' : 'warning');
      
      // IMPORTANTE: Contas pagas NUNCA ficam vermelhas, mesmo se estavam atrasadas
      const rowClass = (conta.status === 'Atrasado' && conta.status !== 'Pago') ? 'table-danger conta-atrasada' : '';
      
      // Definir botões de ação baseado no status
      let botoesAcao = '';
      
      // Mostrar botão Pagar se a conta não estiver paga
      if (conta.status !== 'Pago') {
        botoesAcao += `
          <button class="btn btn-sm btn-success me-1" onclick="pagarConta(${conta.id_contas})" title="Marcar como Pago">
            <i class="fas fa-check-circle"></i> Pagar
          </button>
        `;
      }
      
      // Sempre permitir editar e deletar
      botoesAcao += `
        <button class="btn btn-sm btn-primary me-1" onclick='editarConta(${JSON.stringify(conta)})' title="Editar">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger me-1" onclick="deletarConta(${conta.id_contas})" title="Deletar">
          <i class="fas fa-trash"></i>
        </button>
      `;
      
      // Calcular informações de parcelas
      let infoParcelas = '';
      if (conta.parcelas && conta.parcelas.length > 0) {
        const parcelasPagas = conta.parcelas.filter(p => p.status === 'Pago').length;
        const totalParcelas = conta.parcelas.length;
        const parcelasPendentes = totalParcelas - parcelasPagas;
        
        let badgeClass = 'warning';
        if (parcelasPagas === totalParcelas) {
          badgeClass = 'success';
        } else if (parcelasPendentes > 0 && conta.parcelas.some(p => p.status === 'Atrasado')) {
          badgeClass = 'danger';
        }
        
        infoParcelas = `
          <div class="text-center">
            <span class="badge bg-${badgeClass}">
              <i class="fas fa-calendar-check"></i> ${parcelasPagas}/${totalParcelas}
            </span>
            <br>
            <small class="text-muted">${parcelasPendentes} pendente(s)</small>
          </div>
        `;
      } else {
        infoParcelas = '<span class="text-muted text-center d-block">Sem parcelas</span>';
      }
      
      return `
        <tr class="${rowClass}">
          <td><strong>${conta.descricao}</strong></td>
          <td><strong>${formatarValor(conta.valor)}</strong></td>
          <td>${formatarData(conta.data_vencimento)}</td>
          <td>
            <span class="badge bg-${statusClass}">
              ${conta.status}
              ${conta.status === 'Atrasado' ? '<i class="fas fa-exclamation-triangle ms-1"></i>' : ''}
            </span>
          </td>
          <td>${infoParcelas}</td>
          <td class="text-nowrap">
            ${botoesAcao}
          </td>
        </tr>
      `;
    }).join('');
  }
  
  // Filtro de status
  document.getElementById('filtroStatus').addEventListener('change', function() {
    const filtro = this.value;
    
    if (filtro === '') {
      renderizarContas(contasGlobal);
    } else {
      const contasFiltradas = contasGlobal.filter(conta => conta.status === filtro);
      renderizarContas(contasFiltradas);
    }
  });
  
  // Abrir modal para nova conta
  function abrirModalNovaConta() {
    document.getElementById('modalTitulo').textContent = 'Nova Conta';
    document.getElementById('formConta').reset();
    document.getElementById('contaId').value = '';
    document.getElementById('parcelarConta').checked = false;
    document.getElementById('camposParcelas').style.display = 'none';
    document.getElementById('numeroParcelas').value = '';
    document.getElementById('dataPrimeiraParcela').value = '';
    document.getElementById('previewParcelas').style.display = 'none';
  }

  // Toggle campos de parcelas
  function toggleParcelas() {
    const checkParcelar = document.getElementById('parcelarConta').checked;
    const camposParcelas = document.getElementById('camposParcelas');
    const numParcelas = document.getElementById('numeroParcelas');
    const dataPrimeira = document.getElementById('dataPrimeiraParcela');
    const intervaloDias = document.getElementById('intervaloDias');
    const previewParcelas = document.getElementById('previewParcelas');
    const containerVencimento = document.getElementById('containerVencimento');
    const contaVencimento = document.getElementById('contaVencimento');
    
    if (checkParcelar) {
      // Mostrar campos de parcelas e ocultar vencimento
      camposParcelas.style.display = 'block';
      numParcelas.required = true;
      dataPrimeira.required = true;
      intervaloDias.required = true;
      containerVencimento.style.display = 'none';
      contaVencimento.required = false;
    } else {
      // Ocultar campos de parcelas e mostrar vencimento
      camposParcelas.style.display = 'none';
      numParcelas.required = false;
      dataPrimeira.required = false;
      intervaloDias.required = false;
      numParcelas.value = '';
      dataPrimeira.value = '';
      intervaloDias.value = '30';
      previewParcelas.style.display = 'none';
      containerVencimento.style.display = 'block';
      contaVencimento.required = true;
    }
  }

  // Calcular e mostrar preview das parcelas
  function calcularParcelas() {
    const valorTotal = parseFloat(document.getElementById('contaValor').value) || 0;
    const numParcelas = parseInt(document.getElementById('numeroParcelas').value) || 0;
    const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
    const intervaloDias = parseInt(document.getElementById('intervaloDias').value) || 0;
    const previewDiv = document.getElementById('previewParcelas');
    const previewContent = document.getElementById('parcelasPreviewContent');
    
    // Se não tem todos os dados, ocultar preview
    if (!valorTotal || !numParcelas || !dataPrimeira || !intervaloDias || numParcelas > 12 || numParcelas < 1 || intervaloDias < 1) {
      previewDiv.style.display = 'none';
      return;
    }
    
    // Calcular valor por parcela
    const valorPorParcela = valorTotal / numParcelas;
    const valorFormatado = formatarValor(valorPorParcela);
    
    // Calcular datas com base no intervalo em dias
    const dataInicial = new Date(dataPrimeira);
    const parcelas = [];
    
    for (let i = 0; i < numParcelas; i++) {
      const dataVencimento = new Date(dataInicial);
      dataVencimento.setDate(dataInicial.getDate() + (i * intervaloDias));
      parcelas.push({
        numero: i + 1,
        data: dataVencimento,
        valor: valorPorParcela
      });
    }
    
    // Montar HTML do preview
    previewContent.innerHTML = `
      <strong>Valor por parcela: ${formatarValor(valorTotal)} / ${numParcelas} = ${valorFormatado}</strong>
      <hr style="margin: 0.5rem 0;">
      <div style="max-height: 200px; overflow-y: auto;">
        ${parcelas.map(p => `
          <div class="d-flex justify-content-between align-items-center py-1">
            <span><i class="fas fa-calendar me-1"></i> Parcela ${p.numero}:</span>
            <span><strong>${valorFormatado}</strong> - ${formatarData(p.data.toISOString().split('T')[0])}</span>
          </div>
        `).join('')}
      </div>
    `;
    
    previewDiv.style.display = 'block';
  }
  
  // Editar conta
  function editarConta(conta) {
    document.getElementById('modalTitulo').textContent = 'Editar Conta';
    document.getElementById('contaId').value = conta.id_contas;
    document.getElementById('contaDescricao').value = conta.descricao;
    document.getElementById('contaValor').value = conta.valor;
    document.getElementById('contaVencimento').value = formatarDataInput(conta.data_vencimento);
    
    // Ocultar campos de parcelas ao editar
    document.getElementById('parcelarConta').checked = false;
    document.getElementById('camposParcelas').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('modalConta')).show();
  }

  // Salvar conta
  document.getElementById('formConta').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('contaId').value;
    const parcelarConta = document.getElementById('parcelarConta').checked;
    
    // Se está parcelando, usar a data da primeira parcela como vencimento
    const dataVencimento = parcelarConta 
      ? document.getElementById('dataPrimeiraParcela').value 
      : document.getElementById('contaVencimento').value;
    
    const dados = {
      descricao: document.getElementById('contaDescricao').value,
      valor: parseFloat(document.getElementById('contaValor').value),
      data_vencimento: dataVencimento
      // Status não é mais enviado - será definido automaticamente como 'Pendente'
    };
    
    // Validação: impedir valor negativo ou inválido
    if (isNaN(dados.valor) || dados.valor < 0) {
      showToast('O valor deve ser zero ou positivo.', 'error');
      return;
    }
    
    try {
      let response;
      if (id) {
        // Atualizar
        dados.id_contas = parseInt(id);
        response = await axios.post('/contaspagar/atualizar', dados);
      } else {
        // Criar
        response = await axios.post('/contaspagar/criar', dados);
        
        // Se criou conta com sucesso e tem parcelamento selecionado
        if (response.data.status === 'ok' && document.getElementById('parcelarConta').checked) {
          const numParcelas = document.getElementById('numeroParcelas').value;
          const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
          const intervaloDias = document.getElementById('intervaloDias').value;
          
          if (numParcelas && dataPrimeira && intervaloDias && numParcelas > 0 && numParcelas <= 12) {
            // Chamar endpoint de gerar parcelas
            const idContaCriada = response.data.conta?.id_contas;
            try {
              await axios.post('/parcelas/gerar', {
                id_conta: idContaCriada,
                numero_parcelas: parseInt(numParcelas),
                data_inicial: dataPrimeira,
                intervalo_dias: parseInt(intervaloDias)
              });
            } catch (parcelaError) {
              console.error('Erro ao criar parcelas:', parcelaError);
              showToast('Conta criada, mas houve erro ao criar parcelas', 'error');
            }
          }
        }
      }
      
      if (response.data.status === 'ok') {
        showToast(response.data.msg, 'success');
        bootstrap.Modal.getInstance(document.getElementById('modalConta')).hide();
        carregarContas();
      }
    } catch (error) {
      console.error('Erro ao salvar conta:', error);
      const errorMsg = error.response?.data?.msg || 'Erro ao salvar conta';
      showToast(errorMsg, 'error');
    }
  });
  
  // Deletar conta
  async function deletarConta(id) {
    if (!confirm('Tem certeza que deseja deletar esta conta?')) {
      return;
    }
    
    try {
      const response = await axios.post('/contaspagar/deletar', { id_contas: id });
      
      if (response.data.status === 'ok') {
        showToast('Conta deletada com sucesso!', 'success');
        carregarContas();
      }
    } catch (error) {
      console.error('Erro ao deletar conta:', error);
      const errorMsg = error.response?.data?.msg || 'Erro ao deletar conta';
      showToast(errorMsg, 'error');
    }
  }
  
  // Marcar conta como paga
  async function pagarConta(id) {
    if (!confirm('Deseja marcar esta conta como paga?')) {
      return;
    }
    
    try {
      const response = await axios.post('/contaspagar/pagar', { id_contas: id });
      
      if (response.data.status === 'ok') {
        showToast('Conta marcada como paga!', 'success');
        carregarContas();
      }
    } catch (error) {
      console.error('Erro ao marcar conta como paga:', error);
      const errorMsg = error.response?.data?.msg || 'Erro ao marcar conta como paga';
      showToast(errorMsg, 'error');
    }
  }
  
  // Carregar ao iniciar a página
  window.onload = function() {
    carregarContas();
  };
</script>

{% endblock %}

