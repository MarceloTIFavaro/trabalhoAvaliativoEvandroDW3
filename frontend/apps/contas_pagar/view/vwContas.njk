{% extends "templates/base.html" %}

{% block content %}

<h1 class="mt-4">Gerenciar Contas a Pagar</h1>
<ol class="breadcrumb mb-4">
  <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
  <li class="breadcrumb-item active">Contas a Pagar</li>
</ol>

<!-- Notificações de Contas Atrasadas -->
<div id="notificacoesAtrasadas"></div>

<!-- Ações -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="fas fa-table me-1"></i> Minhas Contas</span>
    <div>
      <select id="filtroStatus" class="form-select form-select-sm d-inline-block w-auto me-2">
        <option value="">Todos os Status</option>
        <option value="Pendente">Pendente</option>
        <option value="Atrasado">Atrasado</option>
        <option value="Pago">Pago</option>
      </select>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalConta" onclick="abrirModalNovaConta()">
        <i class="fas fa-plus"></i> Nova Conta
      </button>
    </div>
  </div>
  <div class="card-body">
    <table class="table table-striped table-hover" id="tabelaContas">
      <thead>
        <tr>
          <th>Descrição</th>
          <th>Valor</th>
          <th>Vencimento</th>
          <th>Status</th>
          <th>Parcelas</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyContas">
        <tr>
          <td colspan="6" class="text-center">
            <i class="fas fa-spinner fa-spin"></i> Carregando contas...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Nova/Editar Conta -->
<div class="modal fade" id="modalConta" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitulo">Nova Conta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="formConta">
        <div class="modal-body">
          <input type="hidden" id="contaId">
          
          <div class="mb-3">
            <label for="contaDescricao" class="form-label">
              <i class="fas fa-file-alt"></i> Descrição *
            </label>
            <input type="text" class="form-control" id="contaDescricao" required placeholder="Ex: Conta de energia">
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="contaValor" class="form-label">
                <i class="fas fa-dollar-sign"></i> Valor (R$) *
              </label>
              <input type="number" class="form-control" id="contaValor" step="0.01" min="0" required placeholder="0.00" oninput="calcularParcelas()">
            </div>
            <div class="col-md-6 mb-3" id="containerVencimento">
              <label for="contaVencimento" class="form-label">
                <i class="fas fa-calendar"></i> Vencimento *
              </label>
              <input type="date" class="form-control" id="contaVencimento" required>
            </div>
          </div>

          <!-- Opção de Parcelamento -->
          <div class="mb-3">
            <label for="parcelarConta" class="form-label">
              <i class="fas fa-calendar-check"></i> Parcelar esta conta
            </label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="parcelarConta" onchange="toggleParcelas()">
              <label class="form-check-label" for="parcelarConta">
                Criar parcelas para esta conta
              </label>
            </div>
          </div>

          <!-- Campos de Parcelamento (ocultos por padrão) -->
          <div id="camposParcelas" style="display: none;">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="numeroParcelas" class="form-label">
                  <i class="fas fa-list-ol"></i> Número de Parcelas (máx. 12)
                </label>
                <input type="number" class="form-control" id="numeroParcelas" min="1" max="12" placeholder="Ex: 3" oninput="calcularParcelas()">
              </div>
              <div class="col-md-4 mb-3">
                <label for="dataPrimeiraParcela" class="form-label">
                  <i class="fas fa-calendar-alt"></i> Data da 1ª Parcela
                </label>
                <input type="date" class="form-control" id="dataPrimeiraParcela" onchange="calcularParcelas()">
              </div>
              <div class="col-md-4 mb-3">
                <label for="intervaloDias" class="form-label">
                  <i class="fas fa-calendar-day"></i> Intervalo entre parcelas (dias) *
                </label>
                <input type="number" class="form-control" id="intervaloDias" min="1" value="30" placeholder="Ex: 30" oninput="calcularParcelas()">
              </div>
            </div>
            
            <!-- Preview das Parcelas -->
            <div id="previewParcelas" style="display: none;" class="alert alert-info mt-3">
              <h6 class="alert-heading"><i class="fas fa-eye"></i> Preview das Parcelas</h6>
              <div id="parcelasPreviewContent" class="small"></div>
            </div>
          </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="btnSalvar">
            <i class="fas fa-save"></i> Salvar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
  const userId = {{ parametros.IdUsuario }};
  let contasGlobal = [];
  let contaEmEdicao = null;
  
  // Função para exibir toast
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    const bgColor = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const toastHTML = `
      <div id="${toastId}" class="toast align-items-center text-white ${bgColor} border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas ${icon} me-2"></i>${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
      toastElement.remove();
    });
  }
  
  // Impedir valores negativos no campo de valor
  document.addEventListener('input', function(e) {
    if (e.target && e.target.id === 'contaValor') {
      const num = parseFloat(e.target.value);
      if (!isNaN(num) && num < 0) {
        e.target.value = 0;
      }
    }
  });
  
  // Função para formatar data (evitar shift de timezone)
  function formatarData(dataStr) {
    if (!dataStr) return '';
    // Se já estiver no formato YYYY-MM-DD, formatar manualmente
    const m = /^\d{4}-\d{2}-\d{2}$/.exec(dataStr);
    if (m) {
      const [ano, mes, dia] = dataStr.split('-');
      return `${dia}/${mes}/${ano}`;
    }
    // Fallback seguro para outros formatos
    const data = new Date(dataStr);
    return isNaN(data.getTime()) ? '' : data.toLocaleDateString('pt-BR');
  }
  
  // Função para formatar data para input (YYYY-MM-DD em fuso local)
  function formatarDataInput(dataStr) {
    if (!dataStr) return '';
    // Se já estiver no formato YYYY-MM-DD, retornar como está
    if (/^\d{4}-\d{2}-\d{2}$/.test(dataStr)) return dataStr;
    const d = new Date(dataStr);
    if (isNaN(d.getTime())) return '';
    const ano = d.getFullYear();
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const dia = String(d.getDate()).padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
  }
  
  // Função para formatar valor
  function formatarValor(valor) {
    return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }
  
  // Função auxiliar para calcular o status efetivo da conta baseado nas parcelas
  function calcularStatusEfetivo(conta) {
    // Se a conta já está paga, mantém como pago
    if (conta.status === 'Pago') {
      return 'Pago';
    }
    
    // Se a conta tem parcelas, calcular baseado nas parcelas
    if (conta.parcelas && conta.parcelas.length > 0) {
      // Filtrar parcelas não pagas
      const parcelasNaoPagas = conta.parcelas.filter(p => 
        p.status !== 'Pago' && p.status !== 'PAGO' && p.status !== 'pago'
      );
      
      // Se todas as parcelas foram pagas, a conta deve estar paga
      if (parcelasNaoPagas.length === 0) {
        return 'Pago';
      }
      
      // Verificar se há parcelas atrasadas pendentes (não pagas)
      const temParcelasAtrasadas = parcelasNaoPagas.some(p => 
        p.status === 'Atrasado' || p.status === 'ATRASADO' || p.status === 'atrasado'
      );
      
      // Se tem parcelas atrasadas pendentes, status é Atrasado
      if (temParcelasAtrasadas) {
        return 'Atrasado';
      }
      
      // Se há parcelas pendentes mas nenhuma atrasada, status é Pendente
      return 'Pendente';
    }
    
    // Para contas sem parcelas, usar o status do backend
    return conta.status || 'Pendente';
  }
  
     // Função para atualizar notificações de contas atrasadas
   function atualizarNotificacoesAtrasadas() {
     // Verificar contas atrasadas usando a função calcularStatusEfetivo
     const contasAtrasadas = contasGlobal.filter(conta => {
       const statusEfetivo = calcularStatusEfetivo(conta);
       return statusEfetivo === 'Atrasado';
     });
     
     const notificacoesDiv = document.getElementById('notificacoesAtrasadas');
     
     if (contasAtrasadas.length > 0) {
       notificacoesDiv.innerHTML = `
         <div class="alert alert-danger alert-dismissible fade show" role="alert">
           <h5 class="alert-heading">
             <i class="fas fa-exclamation-triangle"></i> 
             Atenção! Você tem ${contasAtrasadas.length} conta(s) atrasada(s)
           </h5>
           <hr>
           <ul class="mb-0">
             ${contasAtrasadas.map(c => {
               const vencimentoEfetivo = obterVencimentoEfetivo(c);
               return `<li><strong>${c.descricao}</strong> - Vencimento: ${formatarData(vencimentoEfetivo)} - ${formatarValor(c.valor)}</li>`;
             }).join('')}
           </ul>
           <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
         </div>
       `;
     } else {
       // Limpar notificações se não há contas atrasadas
       notificacoesDiv.innerHTML = '';
     }
   }

   // Função auxiliar para obter o vencimento efetivo da conta (próxima parcela pendente se tiver parcelas)
  function obterVencimentoEfetivo(conta) {
    // Se a conta tem parcelas, buscar a próxima parcela pendente
    if (conta.parcelas && conta.parcelas.length > 0) {
      // Filtrar parcelas não pagas
      const parcelasPendentes = conta.parcelas.filter(p => 
        p.status !== 'Pago' && p.status !== 'PAGO' && p.status !== 'pago'
      );
      
      if (parcelasPendentes.length > 0) {
        // Ordenar por data de vencimento e pegar a primeira (mais próxima)
        parcelasPendentes.sort((a, b) => {
          const dataA = new Date(a.data_vencimento);
          const dataB = new Date(b.data_vencimento);
          return dataA - dataB;
        });
        
        // Retornar o vencimento da próxima parcela pendente
        return parcelasPendentes[0].data_vencimento;
      } else {
        // Se todas as parcelas estão pagas, retornar o vencimento da última parcela
        const parcelasOrdenadas = [...conta.parcelas].sort((a, b) => {
          const dataA = new Date(a.data_vencimento);
          const dataB = new Date(b.data_vencimento);
          return dataB - dataA; // Ordenar do mais recente para o mais antigo
        });
        return parcelasOrdenadas[0]?.data_vencimento || conta.data_vencimento;
      }
    }
    
    // Se não tem parcelas, retornar o vencimento normal da conta
    return conta.data_vencimento;
  }
  
  // Carregar contas
  async function carregarContas() {
    try {
      const response = await axios.get('/contaspagar/listar');
      
      if (response.data.status === 'ok') {
        contasGlobal = response.data.contas;
        
                 // Carregar parcelas para cada conta
         for (let i = 0; i < contasGlobal.length; i++) {
           try {
             const parcelasResponse = await axios.post('/parcelas/listar', { id_conta: contasGlobal[i].id_contas });
             if (parcelasResponse.data.status === 'ok') {
               contasGlobal[i].parcelas = parcelasResponse.data.parcelas || [];
             }
           } catch (error) {
             console.error(`Erro ao carregar parcelas da conta ${contasGlobal[i].id_contas}:`, error);
             contasGlobal[i].parcelas = [];
           }
         }
         
         renderizarContas(contasGlobal);
         
         // Atualizar notificações de contas atrasadas usando o status efetivo calculado
         atualizarNotificacoesAtrasadas();
      }
    } catch (error) {
      console.error('Erro ao carregar contas:', error);
      showToast('Erro ao carregar contas', 'error');
    }
  }
  
     // Renderizar contas na tabela
   function renderizarContas(contas) {
     const tbody = document.getElementById('tbodyContas');
     
     if (contas.length === 0) {
       tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhuma conta cadastrada</td></tr>';
       return;
     }
     
     tbody.innerHTML = contas.map(conta => {
       // Recalcular status efetivo baseado nas parcelas atuais
       const statusEfetivo = calcularStatusEfetivo(conta);
       const statusClass = statusEfetivo === 'Pago' ? 'success' : (statusEfetivo === 'Atrasado' ? 'danger' : 'warning');
       
       // IMPORTANTE: Só fica vermelha se realmente estiver atrasada
       const rowClass = statusEfetivo === 'Atrasado' ? 'table-danger conta-atrasada' : '';
      
             // Definir botões de ação baseado no status efetivo (calculado)
       let botoesAcao = '';
       
       // Mostrar botão Pagar se a conta não estiver paga (usar status efetivo)
       if (statusEfetivo !== 'Pago') {
         botoesAcao += `
           <button class="btn btn-sm btn-success me-1" onclick="pagarConta(${conta.id_contas})" title="Marcar como Pago">
             <i class="fas fa-check-circle"></i> Pagar
           </button>
         `;
       }
      
      // Sempre permitir editar e deletar
      botoesAcao += `
        <button class="btn btn-sm btn-primary me-1" onclick='editarConta(${JSON.stringify(conta)})' title="Editar">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger me-1" onclick="deletarConta(${conta.id_contas})" title="Deletar">
          <i class="fas fa-trash"></i>
        </button>
      `;
      
             // Calcular informações de parcelas
       let infoParcelas = '';
       if (conta.parcelas && conta.parcelas.length > 0) {
         const parcelasPagas = conta.parcelas.filter(p => p.status === 'Pago').length;
         const totalParcelas = conta.parcelas.length;
         const parcelasPendentes = totalParcelas - parcelasPagas;
         
         let badgeClass = 'warning';
         if (parcelasPagas === totalParcelas) {
           badgeClass = 'success';
         } else if (parcelasPendentes > 0 && conta.parcelas.some(p => p.status === 'Atrasado')) {
           badgeClass = 'danger';
         }
         
         infoParcelas = `
           <div class="text-center">
             <span class="badge bg-${badgeClass}">
               <i class="fas fa-calendar-check"></i> ${parcelasPagas}/${totalParcelas}
             </span>
             <br>
             <small class="text-muted">${parcelasPendentes} pendente(s)</small>
           </div>
         `;
       } else {
         infoParcelas = '<span class="text-muted text-center d-block">Sem parcelas</span>';
       }
      
      // Obter vencimento efetivo (próxima parcela pendente se tiver parcelas)
      const vencimentoEfetivo = obterVencimentoEfetivo(conta);
      
      return `
        <tr class="${rowClass}">
          <td><strong>${conta.descricao}</strong></td>
          <td><strong>${formatarValor(conta.valor)}</strong></td>
          <td>${formatarData(vencimentoEfetivo)}</td>
          <td>
            <span class="badge bg-${statusClass}">
              ${statusEfetivo}
              ${statusEfetivo === 'Atrasado' ? '<i class="fas fa-exclamation-triangle ms-1"></i>' : ''}
            </span>
          </td>
                     <td>${infoParcelas}</td>
           <td class="text-nowrap">
             ${botoesAcao}
           </td>
        </tr>
      `;
    }).join('');
  }
  
     // Filtro de status - usar status efetivo calculado
   document.getElementById('filtroStatus').addEventListener('change', function() {
     const filtro = this.value;
     
     if (filtro === '') {
       renderizarContas(contasGlobal);
     } else {
       const contasFiltradas = contasGlobal.filter(conta => {
         const statusEfetivo = calcularStatusEfetivo(conta);
         return statusEfetivo === filtro;
       });
       renderizarContas(contasFiltradas);
     }
   });
  
     // Abrir modal para nova conta
   function abrirModalNovaConta() {
     document.getElementById('modalTitulo').textContent = 'Nova Conta';
     document.getElementById('formConta').reset();
     document.getElementById('contaId').value = '';
     document.getElementById('parcelarConta').checked = false;
     document.getElementById('camposParcelas').style.display = 'none';
     document.getElementById('numeroParcelas').value = '';
     document.getElementById('dataPrimeiraParcela').value = '';
     document.getElementById('intervaloDias').value = '30';
     document.getElementById('previewParcelas').style.display = 'none';
     // Garantir que os campos estejam configurados corretamente
     toggleParcelas();
   }

  // Toggle campos de parcelas
  function toggleParcelas() {
    const checkParcelar = document.getElementById('parcelarConta').checked;
    const camposParcelas = document.getElementById('camposParcelas');
    const numParcelas = document.getElementById('numeroParcelas');
    const dataPrimeira = document.getElementById('dataPrimeiraParcela');
    const intervaloDias = document.getElementById('intervaloDias');
    const previewParcelas = document.getElementById('previewParcelas');
    const containerVencimento = document.getElementById('containerVencimento');
    const contaVencimento = document.getElementById('contaVencimento');
    
    if (checkParcelar) {
      // Mostrar campos de parcelas e ocultar vencimento
      camposParcelas.style.display = 'block';
      numParcelas.required = true;
      dataPrimeira.required = true;
      intervaloDias.required = true;
      containerVencimento.style.display = 'none';
      contaVencimento.required = false;
    } else {
      // Ocultar campos de parcelas e mostrar vencimento
      camposParcelas.style.display = 'none';
      numParcelas.required = false;
      dataPrimeira.required = false;
      intervaloDias.required = false;
      numParcelas.value = '';
      dataPrimeira.value = '';
      intervaloDias.value = '30';
      previewParcelas.style.display = 'none';
      containerVencimento.style.display = 'block';
      contaVencimento.required = true;
    }
  }

  // Calcular e mostrar preview das parcelas
  function calcularParcelas() {
    const valorTotal = parseFloat(document.getElementById('contaValor').value) || 0;
    const numParcelas = parseInt(document.getElementById('numeroParcelas').value) || 0;
    const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
    const intervaloDias = parseInt(document.getElementById('intervaloDias').value) || 0;
    const previewDiv = document.getElementById('previewParcelas');
    const previewContent = document.getElementById('parcelasPreviewContent');
    
    // Se não tem todos os dados, ocultar preview
    if (!valorTotal || !numParcelas || !dataPrimeira || !intervaloDias || numParcelas > 12 || numParcelas < 1 || intervaloDias < 1) {
      previewDiv.style.display = 'none';
      return;
    }
    
    // Calcular valor por parcela
    const valorPorParcela = valorTotal / numParcelas;
    const valorFormatado = formatarValor(valorPorParcela);
    const formatarDataLocalYmd = (d) => {
      const ano = d.getFullYear();
      const mes = String(d.getMonth() + 1).padStart(2, '0');
      const dia = String(d.getDate()).padStart(2, '0');
      return `${ano}-${mes}-${dia}`;
    };
    
    // Calcular datas com base no intervalo em dias
    // Parse localmente YYYY-MM-DD para evitar shift
    const [y, m, d] = dataPrimeira.split('-').map(x => parseInt(x));
    const dataInicial = new Date(y, m - 1, d, 0, 0, 0, 0);
    const parcelas = [];
    
    for (let i = 0; i < numParcelas; i++) {
      const dataVencimento = new Date(dataInicial.getFullYear(), dataInicial.getMonth(), dataInicial.getDate() + (i * intervaloDias), 0, 0, 0, 0);
      parcelas.push({
        numero: i + 1,
        data: dataVencimento,
        valor: valorPorParcela
      });
    }
    
    // Montar HTML do preview
    previewContent.innerHTML = `
      <hr style="margin: 0.5rem 0;">
      <div style="max-height: 200px; overflow-y: auto;">
        ${parcelas.map(p => `
          <div class="d-flex justify-content-between align-items-center py-1">
            <span><i class="fas fa-calendar me-1"></i> Parcela ${p.numero}:</span>
            <span><strong>${valorFormatado}</strong> - ${formatarData(formatarDataLocalYmd(p.data))}</span>
          </div>
        `).join('')}
      </div>
    `;
    
    previewDiv.style.display = 'block';
  }
  
  // Editar conta
  function editarConta(conta) {
    document.getElementById('modalTitulo').textContent = 'Editar Conta';
    document.getElementById('contaId').value = conta.id_contas;
    document.getElementById('contaDescricao').value = conta.descricao;
    document.getElementById('contaValor').value = conta.valor;
    document.getElementById('contaVencimento').value = formatarDataInput(conta.data_vencimento);
    
    // Guardar conta atual em edição
    contaEmEdicao = conta;

    const temParcelas = Array.isArray(conta.parcelas) && conta.parcelas.length > 0;
    const chk = document.getElementById('parcelarConta');
    const campos = document.getElementById('camposParcelas');
    const numParcelasEl = document.getElementById('numeroParcelas');
    const dataPrimeiraEl = document.getElementById('dataPrimeiraParcela');
    const intervaloEl = document.getElementById('intervaloDias');

    if (temParcelas) {
      // Exibir e preencher campos de parcelas automaticamente
      chk.checked = true;
      campos.style.display = 'block';
      numParcelasEl.required = true;
      dataPrimeiraEl.required = true;
      intervaloEl.required = true;

      numParcelasEl.value = conta.parcelas.length;
      // Definir data da 1ª parcela como a menor data_vencimento
      const primeira = [...conta.parcelas].sort((a,b)=> new Date(a.data_vencimento) - new Date(b.data_vencimento))[0];
      if (primeira) {
        dataPrimeiraEl.value = formatarDataInput(primeira.data_vencimento);
      }
      // manter intervalo padrão se não souber o anterior
      if (!intervaloEl.value) intervaloEl.value = '30';
      calcularParcelas();
    } else {
      // Ocultar campos se não há parcelas
      chk.checked = false;
      campos.style.display = 'none';
      numParcelasEl.required = false;
      dataPrimeiraEl.required = false;
      intervaloEl.required = false;
    }
    
    new bootstrap.Modal(document.getElementById('modalConta')).show();
  }

     // Salvar conta
   document.getElementById('formConta').addEventListener('submit', async function(e) {
     e.preventDefault();
     
     const id = document.getElementById('contaId').value;
     const parcelarConta = document.getElementById('parcelarConta').checked;
     
     // Validação: se está parcelando, verificar se os campos de parcelas estão preenchidos
     if (parcelarConta) {
       const numParcelas = document.getElementById('numeroParcelas').value;
       const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
       const intervaloDias = document.getElementById('intervaloDias').value;
       
       if (!numParcelas || !dataPrimeira || !intervaloDias) {
         showToast('Preencha todos os campos de parcelamento!', 'error');
         return;
       }
       
       if (parseInt(numParcelas) < 1 || parseInt(numParcelas) > 12) {
         showToast('O número de parcelas deve estar entre 1 e 12!', 'error');
         return;
       }
       
       if (parseInt(intervaloDias) < 1) {
         showToast('O intervalo entre parcelas deve ser de pelo menos 1 dia!', 'error');
         return;
       }
     }
     
     // Se está parcelando, usar a data da primeira parcela como vencimento
     // Se não está parcelando, usar o campo de vencimento normal
     const dataVencimento = parcelarConta 
       ? document.getElementById('dataPrimeiraParcela').value 
       : document.getElementById('contaVencimento').value;
     
     // Validação: garantir que a data de vencimento foi preenchida
     if (!dataVencimento) {
       showToast('Preencha a data de vencimento!', 'error');
       return;
     }
     
     const dados = {
       descricao: document.getElementById('contaDescricao').value,
       valor: parseFloat(document.getElementById('contaValor').value),
       data_vencimento: dataVencimento
       // Status não é mais enviado - será definido automaticamente como 'Pendente'
     };
     
     // Validação: impedir valor negativo ou inválido
     if (isNaN(dados.valor) || dados.valor < 0) {
       showToast('O valor deve ser zero ou positivo.', 'error');
       return;
     }
     
     try {
       let response;
      if (id) {
        // Atualizar
        dados.id_contas = parseInt(id);
        response = await axios.post('/contaspagar/atualizar', dados);
        
        // Decidir se deve regerar parcelas ao editar
        const numParcelas = document.getElementById('numeroParcelas').value;
        const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
        const intervaloDias = document.getElementById('intervaloDias').value;
        const deveRegerar = parcelarConta || (contaEmEdicao && Array.isArray(contaEmEdicao.parcelas) && contaEmEdicao.parcelas.length > 0 && (numParcelas || dataPrimeira || intervaloDias));

        if (response.data.status === 'ok' && deveRegerar) {
          const numParcelas = document.getElementById('numeroParcelas').value;
          const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
          const intervaloDias = document.getElementById('intervaloDias').value;

          if (numParcelas && dataPrimeira && intervaloDias && parseInt(numParcelas) > 0 && parseInt(numParcelas) <= 12) {
            try {
              await axios.post('/parcelas/regerar', {
                id_conta: parseInt(id),
                numero_parcelas: parseInt(numParcelas),
                data_inicial: dataPrimeira,
                intervalo_dias: parseInt(intervaloDias)
              });
            } catch (parcelaError) {
              console.error('Erro ao regerar parcelas:', parcelaError);
              showToast('Conta atualizada, mas houve erro ao regerar parcelas', 'error');
            }
          }
        }
      } else {
         // Criar
         response = await axios.post('/contaspagar/criar', dados);
         
         // Se criou conta com sucesso e tem parcelamento selecionado
         if (response.data.status === 'ok' && parcelarConta) {
           const numParcelas = document.getElementById('numeroParcelas').value;
           const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
           const intervaloDias = document.getElementById('intervaloDias').value;
           
           if (numParcelas && dataPrimeira && intervaloDias && parseInt(numParcelas) > 0 && parseInt(numParcelas) <= 12) {
             // Chamar endpoint de gerar parcelas
             const idContaCriada = response.data.conta?.id_contas;
             try {
               await axios.post('/parcelas/gerar', {
                 id_conta: idContaCriada,
                 numero_parcelas: parseInt(numParcelas),
                 data_inicial: dataPrimeira,
                 intervalo_dias: parseInt(intervaloDias)
               });
             } catch (parcelaError) {
               console.error('Erro ao criar parcelas:', parcelaError);
               showToast('Conta criada, mas houve erro ao criar parcelas', 'error');
             }
           }
         }
       }
       
      if (response.data.status === 'ok') {
         showToast(response.data.msg, 'success');
         bootstrap.Modal.getInstance(document.getElementById('modalConta')).hide();
         carregarContas();
       }
     } catch (error) {
       console.error('Erro ao salvar conta:', error);
       const errorMsg = error.response?.data?.msg || 'Erro ao salvar conta';
       showToast(errorMsg, 'error');
     }
   });
  
  // Deletar conta
  async function deletarConta(id) {
    if (!confirm('Tem certeza que deseja deletar esta conta?')) {
      return;
    }
    
    try {
      const response = await axios.post('/contaspagar/deletar', { id_contas: id });
      
      if (response.data.status === 'ok') {
        showToast('Conta deletada com sucesso!', 'success');
        carregarContas();
      }
    } catch (error) {
      console.error('Erro ao deletar conta:', error);
      const errorMsg = error.response?.data?.msg || 'Erro ao deletar conta';
      showToast(errorMsg, 'error');
    }
  }
  
  // Marcar conta como paga
  async function pagarConta(id) {
    try {
      // Buscar a conta no array global para ver se tem parcelas
      const conta = contasGlobal.find(c => c.id_contas === id);
      
      if (!conta) {
        showToast('Conta não encontrada', 'error');
        return;
      }
      
      // Se a conta tem parcelas, pagar a próxima parcela pendente
      if (conta.parcelas && conta.parcelas.length > 0) {
        const parcelasPendentes = conta.parcelas
          .filter(p => p.status !== 'Pago')
          .sort((a, b) => new Date(a.data_vencimento) - new Date(b.data_vencimento)); // Ordenar por data
        
        if (parcelasPendentes.length === 0) {
          showToast('Todas as parcelas já foram pagas!', 'info');
          return;
        }
        
        const proximaParcela = parcelasPendentes[0];
        const parcelasPagas = conta.parcelas.filter(p => p.status === 'Pago').length;
        const totalParcelas = conta.parcelas.length;
        
        if (!confirm(`Pagar parcela ${proximaParcela.numero_parcela}? (${parcelasPagas}/${totalParcelas})`)) {
          return;
        }
        
        const response = await axios.post('/parcelas/pagar', { id_parcela: proximaParcela.id_parcela });
        
        if (response.data.status === 'ok') {
          // Recarregar parcelas para verificar se todas foram pagas
          const parcelasResponse = await axios.post('/parcelas/listar', { id_conta: id });
          if (parcelasResponse.data.status === 'ok') {
            const parcelasAtualizadas = parcelasResponse.data.parcelas || [];
            const todasPagas = parcelasAtualizadas.every(p => p.status === 'Pago');
            
            if (todasPagas) {
              // Se todas parcelas pagas, marcar a conta como paga também
              await axios.post('/contaspagar/pagar', { id_contas: id });
              showToast('Todas as parcelas foram pagas! Conta finalizada!', 'success');
            } else {
              showToast('Parcela paga com sucesso!', 'success');
            }
          } else {
            showToast('Parcela paga com sucesso!', 'success');
          }
          
          carregarContas();
        }
      } else {
        // Conta sem parcelas - comportamento normal
        if (!confirm('Deseja marcar esta conta como paga?')) {
          return;
        }
        
        const response = await axios.post('/contaspagar/pagar', { id_contas: id });
        
        if (response.data.status === 'ok') {
          showToast('Conta marcada como paga!', 'success');
          carregarContas();
        }
      }
    } catch (error) {
      console.error('Erro ao marcar conta/parcela como paga:', error);
      const errorMsg = error.response?.data?.msg || 'Erro ao processar pagamento';
      showToast(errorMsg, 'error');
    }
  }
  
    
    
             
  // Carregar ao iniciar a página
  window.onload = function() {
    carregarContas();
  };
</script>

{% endblock %}

